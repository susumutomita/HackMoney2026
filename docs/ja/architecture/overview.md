# アーキテクチャ概要

このドキュメントでは、自律金融のための実行ガバナンスレイヤーであるZeroKey Treasuryの全体アーキテクチャについて説明します。

## ビジョン

x402時代では、AIエージェントが自律的に暗号通貨の支払いを開始します。ZeroKey Treasuryは、欠けていた安全レイヤーを提供します - すべてのトランザクションがブロックチェーンに到達する前に、理解、評価、ポリシー強制を行うファイアウォールです。

---

## システムアーキテクチャ

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           リクエストソース                                    │
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐                     │
│  │  AIエージェント │    │   人間      │    │ x402プロト  │                     │
│  │ (Claude等)   │    │  (ウォレット) │    │ (自動支払)  │                     │
│  └──────┬──────┘    └──────┬──────┘    └──────┬──────┘                     │
└─────────┼──────────────────┼──────────────────┼─────────────────────────────┘
          │                  │                  │
          └─────────────────►┼◄─────────────────┘
                             │
                             ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                         バックエンドサービス                                  │
│  ┌──────────────────────────────────────────────────────────────────────┐  │
│  │                     POST /api/analyze/transaction                    │  │
│  └──────────────────────────────────────────────────────────────────────┘  │
│                                    │                                        │
│                                    ▼                                        │
│  ┌──────────────────────────────────────────────────────────────────────┐  │
│  │                       AIポリシーエンジン                              │  │
│  │  ┌────────────────┐    ┌────────────────┐    ┌─────────────────┐    │  │
│  │  │ トランザクション │───▶│  Claude API    │───▶│  リスク判定     │    │  │
│  │  │ パース          │    │  分析          │    │  (1/2/3)        │    │  │
│  │  └────────────────┘    └────────────────┘    └─────────────────┘    │  │
│  └──────────────────────────────────────────────────────────────────────┘  │
│                                    │                                        │
│                                    ▼                                        │
│  ┌──────────────────────────────────────────────────────────────────────┐  │
│  │                      ポリシーオラクル                                 │  │
│  │  決定に署名し、オンチェーンガードに送信                                │  │
│  └──────────────────────────────────────────────────────────────────────┘  │
└────────────────────────────────────┼────────────────────────────────────────┘
                                     │
                                     ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                        オンチェーンレイヤー                                   │
│  ┌──────────────────────────────────────────────────────────────────────┐  │
│  │                     ZeroKeyGuard.sol                                 │  │
│  │  ┌──────────────┐    ┌──────────────┐    ┌──────────────────────┐   │  │
│  │  │submitDecision│───▶│ approvedTxs  │◄───│ validateTransaction  │   │  │
│  │  │(オラクルのみ) │    │  マッピング   │    │ (拒否時はリバート)   │   │  │
│  │  └──────────────┘    └──────────────┘    └──────────────────────┘   │  │
│  │                             │                                        │  │
│  │                             ▼                                        │  │
│  │                     ┌──────────────┐                                 │  │
│  │                     │   イベント    │                                 │  │
│  │                     │ (監査ログ)    │                                 │  │
│  │                     └──────────────┘                                 │  │
│  └──────────────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## コアコンポーネント

### 1. バックエンドサービス

**パッケージ**: `@zerokey/backend`
**場所**: `packages/backend/`
**技術**: Hono、TypeScript、Anthropic SDK

| コンポーネント       | ファイル                   | 目的                               |
| -------------------- | -------------------------- | ---------------------------------- |
| エントリーポイント   | `src/index.ts`             | Honoアプリ、CORS、ルート           |
| 分析ルート           | `src/routes/analyze.ts`    | トランザクション分析エンドポイント |
| ポリシールート       | `src/routes/policy.ts`     | ポリシーCRUD操作                   |
| アナライザーサービス | `src/services/analyzer.ts` | Claude API統合                     |

**主な特徴**:

- セマンティック分析のためのClaude API統合
- フェイルセーフ設計（LLM失敗 → HIGH_RISK + ブロック）
- 開発用モックモード（APIキー不要）

### 2. スマートコントラクト

**パッケージ**: `@zerokey/contracts`
**場所**: `packages/contracts/`
**技術**: Solidity 0.8.24、Foundry

| コントラクト  | ファイル                           | 目的                     |
| ------------- | ---------------------------------- | ------------------------ |
| ZeroKeyGuard  | `src/ZeroKeyGuard.sol`             | メインガードコントラクト |
| IZeroKeyGuard | `src/interfaces/IZeroKeyGuard.sol` | インターフェース定義     |

**主な関数**:

- `submitDecision()` - オラクルが承認/拒否を送信
- `isApproved()` - トランザクションが承認されているか確認
- `validateTransaction()` - 未承認の場合リバート

### 3. フロントエンド

**パッケージ**: `@zerokey/frontend`
**場所**: `packages/frontend/`
**技術**: Next.js 15、React 19、TailwindCSS、Wagmi、RainbowKit

監視と管理のためのダッシュボード。

### 4. 共有

**パッケージ**: `@zerokey/shared`
**場所**: `packages/shared/`

パッケージ間で使用される共通の型と定数。

---

## データフロー

1. **リクエスト受信** - エージェント/人間/x402がトランザクションを開始
2. **バックエンド分析** - `POST /api/analyze/transaction`がLLM分析をトリガー
3. **リスク評価** - Claudeが評価：分類、リスクレベル、承認
4. **オンチェーン記録** - `ZeroKeyGuard.submitDecision()`が決定を記録
5. **強制** - `validateTransaction()`が未承認の場合リバート

---

## 設計原則

### 1. セマンティック分析

生データをリレーする従来のプロキシとは異なり、ZeroKey Treasuryはトランザクションを理解します：

```typescript
// analyzer.ts プロンプト抜粋
このトランザクションを分析し、以下を返答してください：
1. "riskLevel": 1 (低)、2 (中)、3 (高)
2. "classification": トランザクションの種類 (transfer, swap, lending, unknown)
3. "approved": リスクに基づいて承認するかどうか
4. "reason": 人間が読める説明
```

### 2. フェイルセーフ設計

問題が発生した場合、安全側にデフォルトします：

```typescript
// LLMが失敗した場合、トランザクションをブロック
catch (error) {
  return {
    riskLevel: 3,          // HIGH_RISK
    approved: false,       // ブロック
    reason: "分析失敗 - 予防措置としてトランザクションをブロック",
  };
}
```

### 3. オンチェーン強制

決定はオンチェーンに不変に記録されます：

```solidity
// ポリシーオラクルのみが決定を送信可能
function submitDecision(
  bytes32 txHash,
  bool approved,
  uint256 riskLevel,
  string calldata reason
) external onlyPolicyOracle {
  approvedTransactions[txHash] = approved;
  emit TransactionApproved(txHash, riskLevel, reason);
}
```

### 4. 透明性

すべての決定は：

- オンチェーンイベントとして記録
- 人間が読める理由を伴う
- ブロックエクスプローラーで監査可能

---

## マルチチェーンサポート

ZeroKey Treasuryは複数のEVMチェーンをサポートします：

| チェーン         | Chain ID | ステータス                 |
| ---------------- | -------- | -------------------------- |
| Ethereum Mainnet | 1        | 予定                       |
| Base             | 8453     | 予定                       |
| Base Sepolia     | 84532    | アクティブ（テストネット） |
| Optimism         | 10       | 予定                       |
| Optimism Sepolia | 11155420 | アクティブ（テストネット） |

---

## 関連ドキュメント

- [スマートコントラクト](../components/contracts.md) - コントラクトリファレンス
- [バックエンド](../components/backend.md) - APIサービス詳細
- [セットアップガイド](../guides/setup.md) - インストール手順
